<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Ordini Cucina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .order-card {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>

<div id="loading-overlay" class="loading-overlay">
    <div class="text-xl font-semibold text-gray-700">Caricamento...</div>
</div>

<div class="container flex flex-col items-center">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Ordini per la Cucina</h1>
    <p id="userIdDisplay" class="text-sm text-gray-500 mb-6"></p>

    <!-- Form per l'inserimento degli ordini -->
    <div class="w-full flex flex-col space-y-4">
        <!-- Contenitore per le pietanze multiple -->
        <div id="dishesContainer" class="flex flex-col space-y-2">
            <div class="flex space-x-2">
                <input type="text" placeholder="Piatto (es. Pasta e fagioli)" class="dish-input w-2/3 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                <input type="number" placeholder="Quantità" value="1" min="1" class="quantity-input w-1/3 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
            </div>
        </div>
        <button id="addDishButton" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 rounded-md hover:bg-gray-300 transition duration-200">
            Aggiungi un'altra Pietanza
        </button>

        <input type="text" id="timeInput" placeholder="Orario (es. 12:30)" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
        <button id="addButton" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-md hover:bg-blue-700 transition duration-200 shadow-md">
            Aggiungi Ordine Completo
        </button>
    </div>

    <hr class="w-full my-6 border-t border-gray-200">

    <!-- Lista degli ordini -->
    <div class="w-full">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Lista Ordini</h2>
        <ul id="orderList" class="space-y-4">
            <!-- Gli ordini verranno aggiunti qui dinamicamente -->
        </ul>
        <p id="emptyMessage" class="text-center text-gray-500 mt-8" style="display: none;">Nessun ordine presente. Aggiungine uno!</p>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, onSnapshot, orderBy, query, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variabili globali fornite dall'ambiente
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, auth, db;
    let authIsReady = false;

    // Elementi DOM
    const dishesContainer = document.getElementById('dishesContainer');
    const addDishButton = document.getElementById('addDishButton');
    const timeInput = document.getElementById('timeInput');
    const addButton = document.getElementById('addButton');
    const orderList = document.getElementById('orderList');
    const emptyMessage = document.getElementById('emptyMessage');
    const loadingOverlay = document.getElementById('loading-overlay');
    const userIdDisplay = document.getElementById('userIdDisplay');

    // Funzione per visualizzare messaggi personalizzati (al posto di alert)
    const showCustomMessage = (message, isError = true) => {
        const existingMessage = document.getElementById('custom-message');
        if (existingMessage) {
            existingMessage.remove();
        }
        const messageDiv = document.createElement('div');
        messageDiv.id = 'custom-message';
        messageDiv.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 px-6 py-4 rounded-md shadow-lg z-50 text-center transition-all duration-300 transform scale-0 opacity-0 ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);
        setTimeout(() => {
            messageDiv.classList.add('scale-100', 'opacity-100');
        }, 10);
        setTimeout(() => {
            messageDiv.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => messageDiv.remove(), 300);
        }, 3000);
    };

    // Funzione per riprodurre un suono di notifica
    const playNotificationSound = () => {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (!audioContext) return;
            const now = audioContext.currentTime;
            const frequency1 = 300; 
            const frequency2 = 400; 
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.7, now + 0.1);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.5);
            const oscillator1 = audioContext.createOscillator();
            oscillator1.type = 'sawtooth';
            oscillator1.frequency.setValueAtTime(frequency1, now);
            const oscillator2 = audioContext.createOscillator();
            oscillator2.type = 'sine';
            oscillator2.frequency.setValueAtTime(frequency2, now);
            oscillator1.connect(gainNode);
            oscillator2.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator1.start(now);
            oscillator1.stop(now + 0.5);
            oscillator2.start(now);
            oscillator2.stop(now + 0.5);
        } catch (e) {
            console.error("Errore nella riproduzione del suono:", e);
        }
    };

    // Inizializzazione Firebase e gestione autenticazione
    const initializeFirebase = async () => {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Tenta l'autenticazione
            if (authToken) {
                await signInWithCustomToken(auth, authToken);
            } else {
                await signInAnonymously(auth);
            }

            // Imposta il listener per la sincronizzazione degli ordini solo dopo l'autenticazione
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const userId = user.uid;
                    userIdDisplay.textContent = `Il tuo ID: ${userId}`;
                    authIsReady = true;

                    const ordersCollection = collection(db, `artifacts/${appId}/public/data/kitchen_orders`);
                    const q = query(ordersCollection, orderBy('createdAt', 'desc'));
                    
                    onSnapshot(q, (snapshot) => {
                        const orders = [];
                        snapshot.forEach(doc => {
                            orders.push({ id: doc.id, ...doc.data() });
                        });
                        renderOrders(orders);
                        loadingOverlay.style.display = 'none';
                    });
                } else {
                    userIdDisplay.textContent = 'Autenticazione fallita. Riprova.';
                    loadingOverlay.style.display = 'none';
                }
            });

        } catch (error) {
            console.error("Errore fatale nell'inizializzazione dell'app:", error);
            userIdDisplay.textContent = 'Errore di avvio. Controlla la console per i dettagli.';
            showCustomMessage('Errore: Impossibile connettersi ai servizi. Riprova più tardi.', true);
            loadingOverlay.style.display = 'none';
        }
    };

    // Funzione per il rendering degli ordini
    const renderOrders = (orders) => {
        orderList.innerHTML = '';
        if (orders.length === 0) {
            emptyMessage.style.display = 'block';
        } else {
            emptyMessage.style.display = 'none';
            orders.forEach((order) => {
                const li = document.createElement('li');
                li.className = `order-card bg-gray-50`;
                
                const orderText = document.createElement('div');
                let dishesHtml = '';
                order.dishes.forEach(dish => {
                    if (dish.name) {
                        dishesHtml += `<p class="font-medium text-gray-800">${dish.quantity} x ${dish.name}</p>`;
                    }
                });

                orderText.innerHTML = `
                    <div>${dishesHtml}</div>
                    <p class="text-sm text-gray-500 mt-1">per le ore: ${order.time}</p>
                `;
                li.appendChild(orderText);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex space-x-2';

                // Pulsante "Cancella"
                const deleteButton = document.createElement('button');
                deleteButton.className = 'p-2 rounded-full bg-red-500 text-white hover:bg-red-600';
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                                        </svg>`;
                deleteButton.onclick = async () => {
                    if (!db) {
                        console.error("Database non disponibile.");
                        showCustomMessage("Errore: Impossibile connettersi al database.", true);
                        return;
                    }
                    try {
                        const orderDocRef = doc(db, `artifacts/${appId}/public/data/kitchen_orders`, order.id);
                        await deleteDoc(orderDocRef);
                        showCustomMessage("Ordine cancellato con successo!", false);
                    } catch (e) {
                        console.error("Errore durante la cancellazione dell'ordine:", e);
                        showCustomMessage("Errore: Impossibile cancellare l'ordine. Riprova.", true);
                    }
                };
                actionsDiv.appendChild(deleteButton);

                li.appendChild(actionsDiv);
                orderList.appendChild(li);
            });
        }
    };

    // Aggiungi un nuovo set di campi per una pietanza
    addDishButton.addEventListener('click', () => {
        const newDishDiv = document.createElement('div');
        newDishDiv.className = 'flex space-x-2';
        newDishDiv.innerHTML = `
            <input type="text" placeholder="Piatto" class="dish-input w-2/3 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
            <input type="number" placeholder="Quantità" value="1" min="1" class="quantity-input w-1/3 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
        `;
        dishesContainer.appendChild(newDishDiv);
    });

    // Aggiungi un nuovo ordine completo al database
    const addOrder = async () => {
        if (!authIsReady) {
            showCustomMessage("L'app non è ancora pronta. Attendi qualche istante.", true);
            return;
        }

        const dishInputs = document.querySelectorAll('.dish-input');
        const quantityInputs = document.querySelectorAll('.quantity-input');
        const time = timeInput.value.trim();
        const dishes = [];
        let isValid = true;
        
        for (let i = 0; i < dishInputs.length; i++) {
            const dish = dishInputs[i].value.trim();
            const quantity = parseInt(quantityInputs[i].value, 10);
            
            if (dish && quantity > 0) {
                dishes.push({ name: dish, quantity: quantity });
            } else if (dishInputs.length === 1 && !dish) {
                isValid = false;
                break;
            } else if (dish && quantity <= 0) {
                 isValid = false;
                 showCustomMessage('La quantità deve essere maggiore di 0.', true);
                 return;
            }
        }

        if (dishes.length > 0 && time && isValid) {
            try {
                const newOrder = { 
                    dishes, 
                    time, 
                    createdAt: new Date().toISOString()
                };
                await addDoc(collection(db, `artifacts/${appId}/public/data/kitchen_orders`), newOrder);
                
                playNotificationSound(); 
                
                dishesContainer.innerHTML = `
                    <div class="flex space-x-2">
                        <input type="text" placeholder="Piatto (es. Pasta e fagioli)" class="dish-input w-2/3 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        <input type="number" placeholder="Quantità" value="1" min="1" class="quantity-input w-1/3 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    </div>
                `;
                timeInput.value = '';
            } catch (e) {
                console.error("Errore nell'aggiunta dell'ordine al database:", e);
                showCustomMessage("Errore: Impossibile aggiungere l'ordine. Riprova.", true);
            }
        } else if (!time) {
            showCustomMessage('Per favore, inserisci l\'orario.', true);
        } else {
            showCustomMessage('Per favore, aggiungi almeno una pietanza.', true);
        }
    };

    addButton.addEventListener('click', addOrder);

    // Avvia l'inizializzazione dell'app all'inizio
    initializeFirebase();

</script>

</body>
</html>

