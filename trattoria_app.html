<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Trattoria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ==========================================================
        // PASSO 1: Incolla qui l'oggetto firebaseConfig del tuo progetto
        // ==========================================================
        // SOSTITUISCI L'INTERO BLOCCO SOTTOSTANTE CON IL TUO CODICE DA FIREBASE
        
        const firebaseConfig = {
  apiKey: "AIzaSyA0g-nmjJ_fAjwjoxXeWVs65hl7EcIgKqc",
  authDomain: "gestione-trattoria.firebaseapp.com",
  projectId: "gestione-trattoria",
  storageBucket: "gestione-trattoria.firebasestorage.app",
  messagingSenderId: "583277419731",
  appId: "1:583277419731:web:d542185e8bc04095710826",
  measurementId: "G-ZHX6VKG4VF"        
        // ==========================================================
        // FINE PASSO 1
        // ==========================================================

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;

        const setupFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfigFromCanvas);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        console.log("Utente autenticato con ID:", userId);
                        // Inizializza i listener per i dati
                        setupTableListener();
                        setupOrderListener();
                    } else {
                        console.log("Utente disconnesso.");
                    }
                });
                
            } catch (error) {
                console.error("Errore nell'inizializzazione di Firebase o nell'autenticazione:", error);
                showNotification("Errore di connessione a Firebase. Controlla la tua configurazione.", true);
            }
        };

        const getTablePath = (tableNumber) => `/artifacts/${appId}/public/data/tables/${tableNumber}`;
        const getOrderPath = (tableNumber) => `/artifacts/${appId}/public/data/orders/${tableNumber}`;

        const setupTableListener = () => {
            const tablesCollection = collection(db, `artifacts/${appId}/public/data/tables`);
            onSnapshot(tablesCollection, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const tableData = change.doc.data();
                    const tableNumber = change.doc.id;
                    updateTableStatus(tableNumber, tableData.occupied);
                });
            }, (error) => {
                console.error("Errore nel listener per i tavoli:", error);
                showNotification("Errore nel caricamento dei tavoli.", true);
            });
        };

        const setupOrderListener = () => {
            const ordersCollection = collection(db, `artifacts/${appId}/public/data/orders`);
            onSnapshot(ordersCollection, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const orderData = change.doc.data();
                    const tableNumber = change.doc.id;
                    updateOrderList(tableNumber, orderData.items);
                });
            }, (error) => {
                console.error("Errore nel listener per gli ordini:", error);
                showNotification("Errore nel caricamento degli ordini.", true);
            });
        };

        const updateTableStatus = (tableNumber, isOccupied) => {
            const tableElement = document.getElementById(`table-${tableNumber}`);
            if (tableElement) {
                tableElement.classList.toggle('bg-red-500', isOccupied);
                tableElement.classList.toggle('bg-green-500', !isOccupied);
            }
        };

        const updateOrderList = (tableNumber, items) => {
            const orderListElement = document.getElementById(`order-list-${tableNumber}`);
            if (orderListElement) {
                orderListElement.innerHTML = '';
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    li.className = 'text-sm text-gray-800';
                    orderListElement.appendChild(li);
                });
            }
        };

        const handleTableClick = async (tableNumber) => {
            if (!db) {
                showNotification("Database non ancora connesso.", true);
                return;
            }

            const tableRef = doc(db, getTablePath(tableNumber));
            const orderRef = doc(db, getOrderPath(tableNumber));

            try {
                const tableDoc = await getDoc(tableRef);
                const isOccupied = tableDoc.exists() && tableDoc.data().occupied;

                if (isOccupied) {
                    // Svuota l'ordine e il tavolo
                    await setDoc(orderRef, { items: [] });
                    await updateDoc(tableRef, { occupied: false });
                    showNotification(`Ordine svuotato per il tavolo ${tableNumber}.`);
                } else {
                    // Occupy the table
                    await setDoc(tableRef, { occupied: true });
                    showNotification(`Tavolo ${tableNumber} occupato.`);
                }

            } catch (e) {
                console.error("Errore nell'aggiornare lo stato del tavolo:", e);
                showNotification("Impossibile aggiornare lo stato del tavolo.", true);
            }
        };

        const handleOrderSubmit = async (tableNumber) => {
            if (!db) {
                showNotification("Database non ancora connesso.", true);
                return;
            }
            
            const orderInput = document.getElementById(`order-input-${tableNumber}`);
            const items = orderInput.value.split(',').map(item => item.trim()).filter(item => item !== '');

            if (items.length === 0) {
                showNotification("Inserisci almeno un elemento per l'ordine.", true);
                return;
            }

            const orderRef = doc(db, getOrderPath(tableNumber));
            
            try {
                await setDoc(orderRef, { items: items });
                showNotification(`Ordine inviato per il tavolo ${tableNumber}.`);
                orderInput.value = ''; // Pulisci l'input
            } catch (e) {
                console.error("Errore nell'invio dell'ordine:", e);
                showNotification("Impossibile inviare l'ordine.", true);
            }
        };

        const createTableElements = (numTables) => {
            const container = document.getElementById('tables-container');
            if (!container) return;

            for (let i = 1; i <= numTables; i++) {
                const tableCard = document.createElement('div');
                tableCard.id = `table-${i}`;
                tableCard.className = 'table-card bg-green-500 text-white p-4 rounded-xl shadow-md flex flex-col justify-between transition-transform transform hover:scale-105 cursor-pointer';

                const tableNumber = document.createElement('h3');
                tableNumber.textContent = `Tavolo ${i}`;
                tableNumber.className = 'text-2xl font-bold mb-2';

                const orderSection = document.createElement('div');
                orderSection.className = 'order-section';

                const orderTitle = document.createElement('h4');
                orderTitle.textContent = 'Ordine:';
                orderTitle.className = 'font-semibold mt-2';

                const orderList = document.createElement('ul');
                orderList.id = `order-list-${i}`;
                orderList.className = 'list-disc list-inside mt-1 mb-2';

                const orderInput = document.createElement('input');
                orderInput.type = 'text';
                orderInput.id = `order-input-${i}`;
                orderInput.placeholder = 'Es: 1 pizza, 2 coca';
                orderInput.className = 'mt-2 p-2 w-full rounded-md text-sm text-gray-900 border border-gray-300';

                const orderButton = document.createElement('button');
                orderButton.textContent = 'Invia Ordine';
                orderButton.className = 'mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors';
                orderButton.onclick = (e) => {
                    e.stopPropagation();
                    handleOrderSubmit(i);
                };

                tableCard.appendChild(tableNumber);
                tableCard.appendChild(orderTitle);
                tableCard.appendChild(orderList);
                tableCard.appendChild(orderInput);
                tableCard.appendChild(orderButton);

                tableCard.onclick = () => handleTableClick(i);
                container.appendChild(tableCard);
            }
        };

        const showNotification = (message, isError = false) => {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            notificationText.textContent = message;
            notification.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            notification.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        };

        window.onload = () => {
            createTableElements(10);
            setupFirebase();
        };

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center">

    <div id="notification" class="fixed top-4 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg text-white z-50 transition-opacity duration-300 hidden">
        <span id="notification-text"></span>
    </div>

    <div class="w-full max-w-4xl p-6 bg-white rounded-2xl shadow-xl mt-8 mb-6">
        <h1 class="text-4xl md:text-5xl font-extrabold text-center text-gray-800 mb-2">Gestione Trattoria</h1>
        <p class="text-center text-gray-500 mb-6">
            Gestisci tavoli e ordini in tempo reale.
        </p>

        <!-- Display User ID for debugging -->
        <div class="text-sm text-center text-gray-500 mb-6">
            ID Utente: <span id="user-id" class="font-mono text-xs bg-gray-200 rounded-md px-2 py-1">Caricamento...</span>
        </div>

        <div id="tables-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Table cards will be injected here by JavaScript -->
        </div>

    </div>

</body>
</html>